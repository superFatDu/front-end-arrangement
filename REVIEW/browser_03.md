# 1 浏览器知识总结03

## 1.1 浏览器渲染原理

> 在浏览器中，执行JavaScript有JS引擎，那么执行渲染有渲染引擎（Rendering Engine）,但我们一般称之为浏览器内核。

### 1.1.1 浏览器渲染的过程

1. 浏览器将获取到的HTML文档解析成DOM（Document Object Model）树。
2. 处理CSS标记，构成层叠样式表模型CSSOM（CSS Object Model）。
3. 将DOM和CSSOM合并成渲染树（Redering Tree，代表一系列将被渲染的对象）。
4. 渲染树的每个元素包含的内容都是经过计算的，它被称为布局（layout）。浏览器使用一种流式处理的方法，只需要一次Pass绘制操作就能布局所有的元素。
5. 将渲染树的各个节点绘制到屏幕上，这一步称为Painting。

### 1.1.2 浏览器接收到 HTML 文件并转换为 DOM 树

> 当我们打开一个网页时，浏览器都会去请求对应的HTML文件。

1. HTML文档进行网络传输的时候实际的内容是0/1字节数据，所以，第一步需要将这些**字节数据转换成字符串**，也就是我们写的代码。

```js
字节数据（0/1）=》 字符串
```

2. 当数据被转换成字符串之后，浏览器会**将这些字符串通过词法分析转换成标记（Token)**，这一步在词法分析中叫做标记化（Tokenization）。

```js
字节数据（0/1）=》 字符串 =》 标记
```

![标记](./img/Tokenization.webp)

3. 结束标记后，这些**标记会转换成Node**,最后这些**Node会根据不同的联系构成一个DOM数**。

```js
字节数据（0/1）=》 字符串 =》 标记 => Node => DOM
```

![dom-tree](./img/dom-tree.webp)

### 1.1.3 将 CSS 文件转换为 CSSOM 树

> 在解析HTML文档的时候，浏览器在遇到CSS文件时，浏览器会下载并解析文件。这个过程和构成DOM树的过程很相似，如下：

```js
字节数据（0/1）=》 字符串 =》 标记 => Node => CSSOM
```

- 在这个过程中，浏览器会确定每一个节点的样式到底是什么，并且这一过程十分耗性能。因为样式可以自行设置，也可能继承，所以这个过程需要递归CSSOM树。

```css
<div>
  <a>
    <span></span>
  </a>
</div>

span {
  color: #333333;
}
div > a > span {
  color: #f0ff00;
}
```

- NOTE：1. 我们应该尽量**少写过于具体的CSS选择器，避免过于复杂的递归**。2. 对于HTML来说尽量少添加无意义的标签，保证**层级扁平**。

### 1.1.4 生成渲染树（Rendering Tree）

> 当生成DOM树和CSSOM树后，需要组合构成渲染树。

![render-tree](./img/render-tree.webp)

- **渲染树只会包括需要显示的节点和这些节点的样式信息**，如果某个节点是 display: none 的，那么就不会在渲染树中显示。

- 当浏览器生成渲染树以后，就会**根据渲染树来进行布局（也可以叫做回流）**，然后**调用 GPU 绘制，合成图层，显示在屏幕上**。